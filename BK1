package com.conetdev.mydailydatabase.security;

import java.io.IOException;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;

@Configuration
public class SecurityConfig {

        @Bean
        public AuthenticationSuccessHandler roleBasedSuccessHandler() {
                return new AuthenticationSuccessHandler() {
                        @Override
                        public void onAuthenticationSuccess(HttpServletRequest request,
                                        HttpServletResponse response,
                                        Authentication authentication)
                                        throws IOException, ServletException {
                                // Determine target URL and role name based on authorities
                                String targetUrl = "/"; // fallback
                                String roleName = "";
                                if (authentication.getAuthorities()
                                                .contains(new SimpleGrantedAuthority(
                                                                "ROLE_ADMINISTRADOR DE SISTEMA"))) {
                                        targetUrl = "/administrator";
                                        roleName = "ADMINISTRADOR DE SISTEMA";
                                } else if (authentication.getAuthorities()
                                                .contains(new SimpleGrantedAuthority("ROLE_GERENCIA GENERAL"))) {
                                        targetUrl = "/manager";
                                        roleName = "GERENCIA GENERAL";
                                } else if (authentication.getAuthorities()
                                                .contains(new SimpleGrantedAuthority("ROLE_JEFE ADMINISTRATIVO"))) {
                                        targetUrl = "/executive";
                                        roleName = "JEFE ADMINISTRATIVO";
                                } else if (authentication.getAuthorities()
                                                .contains(new SimpleGrantedAuthority("ROLE_JEFE DE PROYECTOS"))) {
                                        targetUrl = "/project";
                                        roleName = "JEFE DE PROYECTOS";
                                } else if (authentication.getAuthorities()
                                                .contains(new SimpleGrantedAuthority(
                                                                "ROLE_ASISTENTE ADMINISTRATIVO"))) {
                                        targetUrl = "/asistant";
                                        roleName = "ASISTENTE ADMINISTRATIVO";
                                } else if (authentication.getAuthorities()
                                                .contains(new SimpleGrantedAuthority("ROLE_ASISTENTE DE PROYECTOS"))) {
                                        targetUrl = "/asistant";
                                        roleName = "ASISTENTE DE PROYECTOS";
                                } else if (authentication.getAuthorities()
                                                .contains(new SimpleGrantedAuthority("ROLE_ADMINISTRADOR DE OBRA"))) {
                                        targetUrl = "/projectmanager";
                                        roleName = "ADMINISTRADOR DE OBRA";
                                } else if (authentication.getAuthorities()
                                                .contains(new SimpleGrantedAuthority("ROLE_ALMACENERO"))) {
                                        targetUrl = "/storagekeeper";
                                        roleName = "ALMACENERO";
                                } else if (authentication.getAuthorities()
                                                .contains(new SimpleGrantedAuthority("ROLE_REGISTRADOR"))) {
                                        targetUrl = "/register";
                                        roleName = "REGISTRADOR";
                                } else if (authentication.getAuthorities()
                                                .contains(new SimpleGrantedAuthority("ROLE_DIGITADOR"))) {
                                        targetUrl = "/janitor";
                                        roleName = "DIGITADOR";
                                }

                                // Store user info in session
                                HttpSession session = request.getSession();
                                session.setAttribute("username", authentication.getName());
                                session.setAttribute("role", roleName);

                                // Redirect to appropriate URL
                                response.sendRedirect(targetUrl);
                        }
                };
        }

        @Bean
        public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
                http
                                // CSRF (puedes desactivarlo solo si tu API es stateless)
                                .csrf(Customizer.withDefaults())
                                // Autorización de peticiones
                                .authorizeHttpRequests(auth -> auth
                                                // recursos estáticos y página de login sin autenticación
                                                .requestMatchers(
                                                                "/error",
                                                                "/layouts/**",
                                                                "/views/**",
                                                                "/css/**",
                                                                "/fonts/**",
                                                                "/img/**",
                                                                "/js/**",
                                                                "/svg/**",
                                                                "/api/**")
                                                .permitAll()
                                                // cualquier otra petición requiere autenticación
                                                .anyRequest().authenticated())
                                // Form login
                                .formLogin(form -> form
                                                .loginPage("/login")
                                                .loginProcessingUrl("/perform_login")
                                                // .defaultSuccessUrl("/home", true)
                                                .successHandler(roleBasedSuccessHandler())
                                                .failureUrl("/login?error=true")
                                                .permitAll())
                                // Logout
                                .logout(logout -> logout
                                                .logoutUrl("/logout")
                                                .logoutSuccessUrl("/login?logout=true")
                                                .deleteCookies("JSESSIONID")
                                                .invalidateHttpSession(true)
                                                .permitAll());
                return http.build();
        }

        @Bean
        public PasswordEncoder passwordEncoder() {
                return new BCryptPasswordEncoder(10);
        }
}