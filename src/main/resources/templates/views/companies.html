<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/administrators}">

<body>
    <!-- Content -->
    <div layout:fragment="content">
        <!-- Dinamic content -->
        <!-- List -->
        <div v-if="vista === 'list'" class="container-xxl flex-grow-1 container-p-y">
            <div class="align-items-center d-flex justify-content-between mt-0 mb-4">
                <h4 class="fw-bold py-0 mb-0"><span class="text-muted fw-light">Registro /</span> Empresas
                </h4>
                <a @click="cargarVista('create')">
                    <button type="button" class="btn btn-primary">Crear</button>
                </a>
            </div>

            <!-- Cargando -->
            <div v-if="cargando" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Cargando empresas...</p>
            </div>

            <!-- Basic Bootstrap Table -->
            <div v-if="!cargando && empresas.length > 0" class="card">
                <h5 class="card-header">Registro</h5>
                <div class="table-responsive text-nowrap">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>N°</th>
                                <th>Nombre Comercial</th>
                                <th>Razon Social</th>
                                <th>Tipo Identidad</th>
                                <th>Num. Identidad</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="table-border-bottom-0">
                            <tr v-for="(e, i) in empresas" :key="e.id">
                                <td>{{ i + 1 }}</td>
                                <td><strong>{{ e.nombreCorto }}</strong></td>
                                <td>{{ e.nombreLargo }}</td>
                                <td>{{ e.tipoIdentidad.nombreCorto }}</td>
                                <td>{{ e.numIdentidad }}</td>
                                <td>
                                    <span class="badge me-1" :class="getEstadoInfo(e.estado).clase">
                                        {{ getEstadoInfo(e.estado).texto }}
                                    </span>
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button type="button" class="btn p-0 dropdown-toggle hide-arrow"
                                            data-bs-toggle="dropdown">
                                            <i class="bx bx-dots-vertical-rounded"></i>
                                        </button>
                                        <div class="dropdown-menu">
                                            <a @click="modificarUsuarios(e.id)" class="dropdown-item">
                                                <i class="bx bx-user-plus me-1"></i> Asignar Usuarios
                                            </a>
                                            <a @click="seleccionarEmpresa(e.id)" class="dropdown-item">
                                                <i class="bx bx-edit-alt me-1"></i> Editar
                                            </a>
                                            <a href="javascript:void(0);" class="dropdown-item"
                                                @click="prepararEliminar(e.id)">
                                                <i class="bx bx-trash me-1"></i> Eliminar
                                            </a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!--/ Basic Bootstrap Table -->

            <!-- No hay datos -->
            <div v-if="!cargando && empresas.length === 0" class="alert alert-danger w-100 mt-2" role="alert">
                No existen datos que mostrar
            </div>

        </div>
        <!-- /List -->

        <!-- Assign Users -->
        <div v-if="vista === 'assign'" class="container-xxl flex-grow-1 container-p-y">
            <div class="align-items-center d-flex justify-content-between mt-0 mb-4">
                <h4 class="fw-bold py-0 mb-0"><span class="text-muted fw-light">Asignar /</span> Usuarios a Empresa
                </h4>
                <a @click="cargarVista('list')">
                    <button type="button" class="btn btn-primary">Regresar</button>
                </a>
            </div>
            <div class="col-xxl">
                <div class="card mb-4">
                    <div v-if="cargando" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">Cargando usuarios...</p>
                    </div>
                    <div v-else class="card-body">
                        <p class="mb-4">Seleccione los usuarios que desea asignar a la empresa: <strong>{{
                                empresa.nombreCorto }}</strong></p>
                        <div class="row">
                            <div v-for="u in usuariosDisponibles" :key="u.id" class="col-md-4 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" :value="u.id"
                                        v-model="selectedUserIds" :id="'user-' + u.id">
                                    <label class="form-check-label" :for="'user-' + u.id">
                                        {{ u.nombre }} {{ u.apellido }}
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div v-if="usuariosDisponibles.length === 0" class="alert alert-warning">
                            No hay usuarios disponibles para asignar.
                        </div>
                        <div class="row mt-4">
                            <div class="col-12">
                                <button @click="asignarUsuarios" class="btn btn-primary">Guardar Asignación</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Assign Users -->

        <!-- Create -->
        <div v-if="vista === 'create'" class="container-xxl flex-grow-1 container-p-y">
            <div class="align-items-center d-flex justify-content-between mt-0 mb-4">
                <h4 class="fw-bold py-0 mb-0"><span class="text-muted fw-light">Crear /</span> Empresa
                </h4>
                <a @click="cargarVista('list')">
                    <button type="button" class="btn btn-primary">Regresar</button>
                </a>
            </div>
            <!-- Basic Layout -->
            <div class="col-xxl">
                <div class="card mb-4">
                    <!-- Cargando -->
                    <div v-if="cargando" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">Cargando formulario...</p>
                    </div>
                    <div v-else class="card-body">
                        <form @submit.prevent="crearEmpresa">
                            <div class="row mb-3">
                                <label class="col-sm-2 col-form-label">Nombre Corto</label>
                                <div class="col-sm-10">
                                    <input v-model="empresa.nombreCorto" type="text" class="form-control"
                                        placeholder="Ingrese nombre corto de la empresa" required />
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-sm-2 col-form-label">Nombre Largo</label>
                                <div class="col-sm-10">
                                    <input v-model="empresa.nombreLargo" type="text" class="form-control"
                                        placeholder="Ingrese nombre largo de la empresa" required />
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-sm-2 col-form-label">Tipo Identidad</label>
                                <div class="col-sm-10">
                                    <select v-model="empresa.tipoIdentidadId" class="form-select" required>
                                        <option :value="null" disabled selected>Seleccione un tipo de identidad
                                        </option>
                                        <option :value="1">N/A</option>
                                        <option :value="2">DNI</option>
                                        <option :value="3">CARNET EXT.</option>
                                        <option :value="6">PASAPORTE</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-sm-2 col-form-label">Num. de identidad</label>
                                <div class="col-sm-10">
                                    <input v-model="empresa.numIdentidad" type="text" class="form-control"
                                        placeholder="Ingrese el numero de identidad de la empresa" required />
                                </div>
                            </div>
                            <div class="row justify-content-end">
                                <div class="col-sm-10">
                                    <button type="submit" class="btn btn-primary">Guardar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Create -->

        <!-- Edit -->
        <div v-if="vista === 'edit'" class="container-xxl flex-grow-1 container-p-y">
            <div class="align-items-center d-flex justify-content-between mt-0 mb-4">
                <h4 class="fw-bold py-0 mb-0"><span class="text-muted fw-light">Editar /</span> Empresa
                </h4>
                <a @click="cargarVista('list')">
                    <button type="button" class="btn btn-primary">Regresar</button>
                </a>
            </div>
            <!-- Basic Layout -->
            <div class="col-xxl">
                <div class="card mb-4">
                    <!-- Cargando -->
                    <div v-if="cargando" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">Cargando formulario...</p>
                    </div>
                    <div v-else class="card-body">
                        <form @submit.prevent="actualizarEmpresa">
                            <div class="row mb-3">
                                <label class="col-sm-2 col-form-label">Nombre Corto</label>
                                <div class="col-sm-10">
                                    <input v-model="empresa.nombreCorto" type="text" class="form-control"
                                        placeholder="Ingrese nombre corto de la empresa" required />
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-sm-2 col-form-label">Nombre Largo</label>
                                <div class="col-sm-10">
                                    <input v-model="empresa.nombreLargo" type="text" class="form-control"
                                        placeholder="Ingrese nombre largo de la empresa" required />
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-sm-2 col-form-label">Tipo Identidad</label>
                                <div class="col-sm-10">
                                    <select v-model="empresa.tipoIdentidadId" class="form-select" required>
                                        <option :value="null" disabled selected>Seleccione un tipo de identidad
                                        </option>
                                        <option :value="1">N/A</option>
                                        <option :value="2">DNI</option>
                                        <option :value="3">CARNET EXT.</option>
                                        <option :value="6">PASAPORTE</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-sm-2 col-form-label">Num. de identidad</label>
                                <div class="col-sm-10">
                                    <input v-model="empresa.numIdentidad" type="text" class="form-control"
                                        placeholder="Ingrese el numero de identidad de la empresa" required />
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-sm-2 col-form-label">Estado</label>
                                <div class="col-sm-10">
                                    <select v-model="empresa.estado" class="form-select" required>
                                        <option :value="1">Activo</option>
                                        <option :value="2">Suspendido</option>
                                        <option :value="3">Eliminado</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row justify-content-end">
                                <div class="col-sm-10">
                                    <button type="submit" class="btn btn-primary">Actualizar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Edit -->

    </div>
    <!-- / Content -->

    <!-- vue.js -->
    <script layout:fragment="script">
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    // VARIABLES SESION
                    userSession: {
                        username: '',
                        fullName: '',
                        roleId: '',
                        roleName: ''
                    },
                    // VARIABLES GENERALES
                    vista: '',
                    modalTitulo: '',
                    modalMensaje: '',
                    modalTipo: '',
                    cargando: null,
                    error: null,
                    // VARIABLES EMPRESAS
                    empresas: [],
                    empresa: {
                        id: null,
                        tipoIdentidad: { id: null },
                        nombreCorto: '',
                        nombreLargo: '',
                        numIdentidad: '',
                        estado: 1
                    },
                    empresaid: null,
                    usuariosDisponibles: [],
                    selectedUserIds: [],
                }
            },
            methods: {
                // METODOS SESION
                cargarSesion: function () {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    const config = {
                        headers: { [csrfHeader]: csrfToken }
                    };
                    axios.get('/api/v1/auth/current-user', config)
                        .then(response => {
                            this.userSession = response.data;
                        })
                        .catch(error => {
                            console.error("Error al verificar sesión:", error);
                        });
                },
                salirSesion: function () {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    const config = {
                        headers: { [csrfHeader]: csrfToken }
                    };
                    this.ocultarModal('modalLogout');
                    axios.post('/api/v1/auth/logout', {}, config)
                        .then(() => {
                            localStorage.clear();
                            window.location.href = "/login";
                        })
                        .catch(error => {
                            console.error("Error al cerrar sesión:", error);
                        });
                },
                // METODOS GENERALES
                modalGeneral: function (titulo, mensaje, tipo) {
                    this.modalTitulo = titulo;
                    this.modalMensaje = mensaje;
                    this.modalTipo = tipo;
                    this.mostrarModal('modalGeneral');
                },
                mostrarModal: function (idModal) {
                    const elemento = document.getElementById(idModal);
                    if (elemento) {
                        const modal = bootstrap.Modal.getOrCreateInstance(elemento);
                        modal.show();
                    }
                },
                ocultarModal: function (idModal) {
                    const elemento = document.getElementById(idModal);
                    if (elemento) {
                        const modal = bootstrap.Modal.getInstance(elemento);
                        if (modal) modal.hide();
                    }
                },
                cargarVista: function (view) {
                    switch (view) {
                        case 'list':
                            this.vista = 'list';
                            this.cargarEmpresas();
                            break;
                        case 'create':
                            this.vista = 'create';
                            this.limpiarEmpresa();
                            break;
                        case 'edit':
                            this.vista = 'edit';
                            this.cargarEmpresa(this.empresaid);
                            break;
                        case 'assign':
                            this.vista = 'assign';
                            this.cargarUsuariosDisponibles();
                            break;
                    }
                },
                getEstadoInfo: function (codigo) {
                    switch (codigo) {
                        case 1: return { texto: "Activo", clase: "bg-label-success" };
                        case 2: return { texto: "Suspendido", clase: "bg-label-warning" };
                        case 3: return { texto: "Eliminado", clase: "bg-label-danger" };
                        default: return { texto: "Desconocido", clase: "bg-label-secondary" };
                    }
                },
                // METODOS LISTADO
                cargarEmpresas: function () {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    this.cargando = true;
                    const config = {
                        headers: { [csrfHeader]: csrfToken }
                    };

                    axios.get('/api/v1/empresa/cargar', config)
                        .then(response => {
                            this.empresas = response.data;
                        }).catch(error => {
                            console.error("Error cargando empresas:", error);
                            this.modalGeneral('Error', 'No se pudieron cargar las empresas.', 'text-danger');
                        }).finally(() => {
                            this.cargando = false;
                        });
                },
                // METODOS CREAR
                crearEmpresa: function () {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    const config = {
                        headers: { [csrfHeader]: csrfToken }
                    };

                    const payload = {
                        tipoIdentidadId: this.empresa.tipoIdentidadId,
                        nombreCorto: this.empresa.nombreCorto,
                        nombreLargo: this.empresa.nombreLargo,
                        numIdentidad: this.empresa.numIdentidad,
                        estado: this.empresa.estado
                    };

                    axios.post('/api/v1/empresa/crear', payload, config)
                        .then(response => {
                            this.modalGeneral("Éxito", "Empresa creada correctamente", "text-success");
                            this.cargarVista('list');
                        }).catch(error => {
                            console.error("Error creando empresa:", error);
                            this.modalGeneral('Error', 'Ocurrió un error al crear la empresa.', 'text-danger');
                        });
                },
                // METODOS EDITAR
                seleccionarEmpresa: function (id) {
                    this.empresaid = id;
                    this.cargarVista('edit');
                },
                cargarEmpresa: function (id) {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    this.cargando = true;
                    const config = {
                        headers: { [csrfHeader]: csrfToken },
                    };

                    axios.get(`/api/v1/empresa/buscar/${id}`, config)
                        .then(response => {
                            this.empresa = response.data;
                        }).catch(error => {
                            console.error("Error cargando empresa:", error);
                            this.modalGeneral('Error', 'No se pudieron cargar los datos de la empresa.', 'text-danger');
                        }).finally(() => {
                            this.cargando = false;
                        });
                },
                actualizarEmpresa: function () {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    const config = {
                        headers: { [csrfHeader]: csrfToken }
                    };

                    const payload = {
                        tipoIdentidadId: this.empresa.tipoIdentidadId,
                        nombreCorto: this.empresa.nombreCorto,
                        nombreLargo: this.empresa.nombreLargo,
                        numIdentidad: this.empresa.numIdentidad,
                        estado: this.empresa.estado
                    };

                    axios.put(`/api/v1/empresa/actualizar/${this.empresaid}`, payload, config)
                        .then(response => {
                            this.modalGeneral("Éxito", "Empresa actualizada correctamente", "text-success");
                            this.cargarVista('list');
                        }).catch(error => {
                            console.error("Error actualizando empresa:", error);
                            this.modalGeneral('Error', 'No se pudo actualizar la empresa.', 'text-danger');
                        });
                },
                // METODOS ELIMINAR
                prepararEliminar: function (id) {
                    this.empresaid = id;
                    this.mostrarModal('modalDelete');
                },
                eliminarEmpresa: function () {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    const config = {
                        headers: { [csrfHeader]: csrfToken },
                    };

                    axios.delete(`/api/v1/empresa/eliminar/${this.empresaid}`, config)
                        .then(response => {
                            this.ocultarModal('modalDelete');
                            this.modalGeneral("Éxito", "Empresa eliminada correctamente", "text-success");
                            this.cargarVista('list');
                        })
                        .catch(error => {
                            console.error(error);
                            this.ocultarModal('modalDelete');
                            this.modalGeneral("Error", "No se pudo eliminar la empresa", "text-danger");
                        });
                },
                limpiarEmpresa: function () {
                    this.empresa = {
                        id: null,
                        tipoIdentidadId: null,
                        nombreCorto: '',
                        nombreLargo: '',
                        numIdentidad: '',
                        estado: 1
                    };
                },
                // METODOS ASIGNACIÓN
                modificarUsuarios: function (id) {
                    this.empresaid = id;
                    // Pre-cargar la empresa para mostrar el nombre
                    this.cargarEmpresa(id);
                    this.cargarVista('assign');
                },
                cargarUsuariosDisponibles: function () {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    this.cargando = true;
                    const config = {
                        headers: { [csrfHeader]: csrfToken }
                    };

                    axios.get('/api/v1/usuario/cargar', config)
                        .then(response => {
                            this.usuariosDisponibles = response.data;
                            // En una implementación real, aquí se marcarían los usuarios ya asignados
                        }).catch(error => {
                            console.error("Error cargando usuarios:", error);
                        }).finally(() => {
                            this.cargando = false;
                        });
                },
                asignarUsuarios: function () {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    const config = {
                        headers: { [csrfHeader]: csrfToken }
                    };

                    const payload = {
                        userIds: this.selectedUserIds
                    };

                    axios.put(`/api/v1/empresa//asignar-usuarios/${this.empresaid}`, payload, config)
                        .then(response => {
                            this.modalGeneral("Éxito", "Usuarios asignados correctamente", "text-success");
                            this.cargarVista('list');
                        }).catch(error => {
                            console.error("Error asignando usuarios:", error);
                            this.modalGeneral('Error', 'No se pudieron asignar los usuarios.', 'text-danger');
                        });
                },
            },
            mounted() {
                this.cargarSesion();
                this.cargarVista('list');
            }
        }).mount('#app');
    </script>
    <!-- / vue.js -->

</body>

</html>