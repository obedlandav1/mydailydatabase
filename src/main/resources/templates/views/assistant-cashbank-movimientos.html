<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/assistants}">

<body>
    <!-- Content -->
    <div layout:fragment="content">
        <!-- Dynamic content -->
        <div class="container-xxl flex-grow-1 container-p-y pt-2" id="app" v-cloak>
            <!-- Encabezado -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <h4 class="fw-bold py-0 mb-0"><span class="text-muted fw-light">Caja y Bancos /</span> Movimientos</h4>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-success" @click="abrirModalImportar">
                        <i class="bx bx-download me-2"></i>Importar Datos
                    </button>
                </div>
            </div>

            <!-- Vista Lista de Movimientos -->
            <div v-if="vista === 'lista'" class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Movimientos Registrados</h5>
                        </div>
                        <div class="card-body">
                            <div v-if="cargando" class="text-center">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2 text-muted">Cargando datos...</p>
                            </div>
                            <div v-else-if="movimientos.length === 0" class="alert alert-info">
                                No hay movimientos registrados.
                            </div>
                            <div v-else>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Fecha Emisión</th>
                                                <th>Descripción</th>
                                                <th>Beneficiario</th>
                                                <th>Monto 1</th>
                                                <th>Tipo Cambio</th>
                                                <th>Monto 2</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="m in movimientos" :key="m.id">
                                                <td>{{ m.id }}</td>
                                                <td>{{ m.fechaEmision }}</td>
                                                <td>{{ m.descripcionOperacion }}</td>
                                                <td>{{ m.beneficiarioOperacion }}</td>
                                                <td>{{ m.montoOperacion1 }}</td>
                                                <td>{{ m.tipoCambio }}</td>
                                                <td>{{ m.montoOperacion2 }}</td>
                                                <td>
                                                    <span v-if="m.estado === 1" class="badge bg-success">Activo</span>
                                                    <span v-else-if="m.estado === 2" class="badge bg-warning">Suspendido</span>
                                                    <span v-else class="badge bg-danger">Eliminado</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de Importación -->
            <div class="modal fade" id="modalImportar" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Importar Movimientos</h5>
                            <button type="button" class="btn-close" @click="cerrarModalImportar"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Paso 1: Carga de archivo -->
                            <div v-if="pasoImport === 1">
                                <div class="mb-3">
                                    <label class="form-label"><strong>Selecciona la Cuenta *</strong></label>
                                    <select class="form-select" v-model.number="cuentaSeleccionada" required>
                                        <option value="">-- Selecciona una cuenta --</option>
                                        <option v-for="c in cuentas" :key="c.id" :value="c.id">
                                            {{ c.nombre }} ({{ c.numero }})
                                        </option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label"><strong>Selecciona archivo Excel (.xlsx)</strong></label>
                                    <input type="file" class="form-control" 
                                        @change="onArchivoSeleccionado" 
                                        accept=".xlsx" />
                                </div>
                                <div class="alert alert-info small">
                                    <strong>Columnas esperadas (en orden):</strong><br>
                                    1. Fecha Emisión (yyyy-MM-dd)<br>
                                    2. Fecha Operación (yyyy-MM-dd)<br>
                                    3. Período<br>
                                    4. Número Operación<br>
                                    5. Descripción<br>
                                    6. Beneficiario<br>
                                    7. Glosa<br>
                                    8. Monto 1 (número)<br>
                                    9. Tipo Cambio (número)<br>
                                    10. Monto 2 (número)<br>
                                    11. ID Tipo Operación
                                </div>
                            </div>

                            <!-- Paso 2: Preview de datos -->
                            <div v-if="pasoImport === 2">
                                <p class="text-muted mb-3">Se encontraron {{ datosImport.length }} registros válidos.</p>
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>Fecha Emisión</th>
                                                <th>Descripción</th>
                                                <th>Beneficiario</th>
                                                <th>Monto 1</th>
                                                <th>Monto 2</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(d, idx) in datosImport" :key="idx">
                                                <td>{{ d.fechaEmision }}</td>
                                                <td>{{ d.descripcionOperacion }}</td>
                                                <td>{{ d.beneficiarioOperacion }}</td>
                                                <td>{{ d.montoOperacion1 }}</td>
                                                <td>{{ d.montoOperacion2 }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div v-if="erroresImport.length > 0" class="alert alert-warning mt-3 small">
                                    <strong>Registros con errores:</strong>
                                    <ul class="mb-0">
                                        <li v-for="(e, idx) in erroresImport.slice(0, 5)" :key="idx">{{ e }}</li>
                                        <li v-if="erroresImport.length > 5">... y {{ erroresImport.length - 5 }} más</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @click="cerrarModalImportar">Cancelar</button>
                            
                            <!-- Paso 1: Botones -->
                            <div v-if="pasoImport === 1">
                                <button type="button" class="btn btn-info me-2" @click="descargarPlantilla">
                                    <i class="bx bx-cloud-download"></i> Descargar Plantilla
                                </button>
                                <button type="button" class="btn btn-primary" @click="validarExcel" :disabled="!cuentaSeleccionada || !archivoSeleccionado || validando">
                                    <span v-if="validando" class="spinner-border spinner-border-sm me-2"></span>
                                    Importar
                                </button>
                            </div>

                            <!-- Paso 2: Botón Aceptar -->
                            <div v-if="pasoImport === 2">
                                <button type="button" class="btn btn-success" @click="guardarLote" :disabled="guardando">
                                    <span v-if="guardando" class="spinner-border spinner-border-sm me-2"></span>
                                    Aceptar e Importar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cargando general -->
            <div v-if="cargandoGeneral" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Procesando...</p>
            </div>
        </div>

    </div>
    <!-- / Content -->

    <!-- vue.js -->
    <script layout:fragment="script">
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    // VARIABLES SESION
                    userSession: {
                        username: '',
                        fullName: '',
                        roleId: '',
                        roleName: ''
                    },
                    // VARIABLES MOVIMIENTOS
                    movimientos: [],
                    cuentas: [],
                    cuentaSeleccionada: null,
                    vista: 'lista',
                    cargando: false,
                    cargandoGeneral: false,
                    // VARIABLES IMPORTACIÓN
                    pasoImport: 1,
                    archivoSeleccionado: null,
                    datosImport: [],
                    erroresImport: [],
                    validando: false,
                    guardando: false,
                    // VARIABLES GENERALES
                    modalTitulo: '',
                    modalMensaje: '',
                    modalTipo: '',
                }
            },
            methods: {
                // METODOS SESION
                cargarSesion: function () {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    const config = {
                        headers: { [csrfHeader]: csrfToken }
                    };
                    axios.get('/api/v1/auth/current-user', config)
                        .then(response => {
                            this.userSession = response.data;
                        })
                        .catch(error => {
                            console.error("Error al verificar sesión:", error);
                            if (error.response) {
                                switch (error.response.status) {
                                    case 401:
                                        this.modalError('Error', 'Solicitud no autorizada, recargue la página.', 'text-danger');
                                        break;
                                    case 403:
                                        this.modalError('Error', 'Sesión no autorizada, vuelva a iniciar sesión.', 'text-warning');
                                        break;
                                    default:
                                        this.modalError('Error inesperado', 'Problema en el servidor.', 'text-muted');
                                }
                            } else {
                                this.modalError('Error de conexión', 'No se pudo contactar con el servidor.', 'text-danger');
                            }
                        });
                },
                salirSesion: function () {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    const config = {
                        headers: { [csrfHeader]: csrfToken }
                    };
                    this.ocultarModal('modalLogout');
                    axios.post('/api/v1/auth/logout', {}, config)
                        .then(() => {
                            localStorage.clear();
                            this.userSession = {
                                username: '',
                                fullName: '',
                                roleId: '',
                                roleName: ''
                            };
                            this.modalGeneral('Sesión cerrada', 'Sesión cerrada, vuelva a iniciar sesión.', 'text-success');
                            setTimeout(() => {
                                window.location.href = "/login";
                            }, 1500);
                        })
                        .catch(error => {
                            console.error("Error al cerrar sesión:", error);
                            if (error.response) {
                                this.modalError('Error', 'Error al cerrar sesión, recargue la página.', 'text-danger');
                            } else {
                                this.modalError('Error de conexión', 'No se pudo contactar con el servidor.', 'text-danger');
                            }
                        });
                },
                // METODOS IMPORTACIÓN
                abrirModalImportar() {
                    this.pasoImport = 1;
                    this.archivoSeleccionado = null;
                    this.datosImport = [];
                    this.erroresImport = [];
                    this.cuentaSeleccionada = null;
                    this.mostrarModal('modalImportar');
                },
                cerrarModalImportar() {
                    this.ocultarModal('modalImportar');
                    this.pasoImport = 1;
                    this.archivoSeleccionado = null;
                    this.cuentaSeleccionada = null;
                },
                onArchivoSeleccionado(event) {
                    this.archivoSeleccionado = event.target.files[0];
                },
                validarExcel() {
                    if (!this.cuentaSeleccionada) {
                        this.modalGeneral('Advertencia', 'Selecciona una cuenta', 'text-warning');
                        return;
                    }
                    if (!this.archivoSeleccionado) {
                        this.modalGeneral('Advertencia', 'Selecciona un archivo', 'text-warning');
                        return;
                    }

                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    const formData = new FormData();
                    formData.append('file', this.archivoSeleccionado);

                    const config = {
                        headers: {
                            [csrfHeader]: csrfToken,
                            'Content-Type': 'multipart/form-data'
                        }
                    };

                    this.validando = true;

                    axios.post('/api/v1/movimiento/validar-excel', formData, config)
                        .then(response => {
                            if (response.data.status === 'OK') {
                                this.datosImport = response.data.datos;
                                this.erroresImport = response.data.errores || [];
                                this.pasoImport = 2;
                                this.validando = false;
                            } else {
                                this.modalGeneral('Error', response.data.mensaje || 'Error en validación', 'text-danger');
                                this.validando = false;
                            }
                        })
                        .catch(error => {
                            console.error("Error validando:", error);
                            this.modalGeneral(
                                'Error',
                                error.response?.data?.mensaje || 'Error al validar archivo',
                                'text-danger'
                            );
                            this.validando = false;
                        });
                },
                guardarLote() {
                    if (this.datosImport.length === 0) {
                        this.modalGeneral('Advertencia', 'No hay datos para importar', 'text-warning');
                        return;
                    }

                    // Asignar cuentasId a cada movimiento antes de guardar
                    const datosConCuenta = this.datosImport.map(d => ({
                        ...d,
                        cuentasId: this.cuentaSeleccionada
                    }));

                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    const config = {
                        headers: { [csrfHeader]: csrfToken }
                    };

                    this.guardando = true;

                    axios.post('/api/v1/movimiento/guardar-lote', datosConCuenta, config)
                        .then(response => {
                            if (response.data.status === 'OK') {
                                this.modalGeneral(
                                    'Importación Exitosa',
                                    `Se importaron ${response.data.exitosos} de ${response.data.total} movimientos`,
                                    'text-success'
                                );
                                this.cerrarModalImportar();
                                this.cargarMovimientos();
                                this.guardando = false;
                            } else {
                                this.modalGeneral('Error', 'Error en la importación', 'text-danger');
                                this.guardando = false;
                            }
                        })
                        .catch(error => {
                            console.error("Error guardando:", error);
                            this.modalGeneral('Error', 'Error al guardar datos', 'text-danger');
                            this.guardando = false;
                        });
                },
                descargarPlantilla() {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    const config = {
                        headers: { [csrfHeader]: csrfToken },
                        responseType: 'blob'
                    };

                    axios.get('/api/v1/movimiento/descargar-plantilla', config)
                        .then(response => {
                            // Crear descarga
                            const url = window.URL.createObjectURL(new Blob([response.data]));
                            const link = document.createElement('a');
                            link.href = url;
                            link.setAttribute('download', 'plantilla_movimientos.xlsx');
                            document.body.appendChild(link);
                            link.click();
                            link.parentURL.removeChild(link);

                            this.modalGeneral('Descarga', 'Plantilla descargada exitosamente', 'text-success');
                        })
                        .catch(error => {
                            console.error("Error descargando:", error);
                            this.modalGeneral('Error', 'Error al descargar plantilla', 'text-danger');
                        });
                },
                // METODOS GENERALES
                modalError(titulo, mensaje, tipo) {
                    this.modalTitulo = titulo;
                    this.modalMensaje = mensaje;
                    this.modalTipo = tipo;
                    this.mostrarModal('modalError');
                },
                modalGeneral(titulo, mensaje, tipo) {
                    this.modalTitulo = titulo;
                    this.modalMensaje = mensaje;
                    this.modalTipo = tipo;
                    this.mostrarModal('modalGeneral');
                },
                mostrarModal(idModal) {
                    const elemento = document.getElementById(idModal);
                    if (elemento) {
                        const modal = bootstrap.Modal.getOrCreateInstance(elemento);
                        modal.show();
                    } else {
                        console.error("No se encontró el modal:", idModal);
                    }
                },
                ocultarModal(idModal) {
                    const elemento = document.getElementById(idModal);
                    if (elemento) {
                        const modal = bootstrap.Modal.getInstance(elemento);
                        if (modal) modal.hide();
                    } else {
                        console.error("No se encontró el modal:", idModal);
                    }
                },
                cargarCuentas() {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    const config = {
                        headers: { [csrfHeader]: csrfToken }
                    };

                    axios.get('/api/v1/cuenta/listar', config)
                        .then(response => {
                            this.cuentas = response.data.map(c => ({
                                id: c.id,
                                nombre: `${c.razonSocialNombre} - ${c.tipoCuentaNombre}`,
                                numero: c.numeroCuenta,
                                banco: c.bancoNombre,
                                moneda: c.tipoMonedaCodigo
                            }));
                        })
                        .catch(error => {
                            console.error("Error al cargar cuentas:", error);
                            // Usar datos simulados si la API falla
                            this.cuentas = [
                                { id: 1, nombre: 'Caja Principal', numero: 'CAJA-001', banco: 'Caja', moneda: 'PEN' },
                                { id: 2, nombre: 'Banco ABC - Cuenta Corriente', numero: '123456789', banco: 'Banco ABC', moneda: 'USD' },
                                { id: 3, nombre: 'Banco XYZ - Ahorros', numero: '987654321', banco: 'Banco XYZ', moneda: 'PEN' }
                            ];
                        });
                },
            },
            mounted() {
                this.cargarSesion();
                this.cargarMovimientos();
                this.cargarCuentas();
            }
        }).mount('#app');
    </script>
</body>

</html>
